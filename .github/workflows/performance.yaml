name: Performance
run-name: Test ${{ inputs.testToRun }} against ${{ inputs.URN }}

on:
  push:
    branches:
      - performance-testing

  workflow_dispatch:
    inputs:
      runImport:
        description: "Create and import a cohort (not needed if there are already enough patients)"
        required: true
        type: boolean
        default: false
      runConsent:
        description: "Run consent journey"
        required: true
        type: boolean
        default: true
      runNurse:
        description: "Run the nurse journey"
        required: true
        type: boolean
        default: true
      URN:
        description: "Required: what URN to run the test against."
        required: true
        type: string
      duration:
        description: "Optional (default 3600) Duration of nurse journey test, in seconds. This will include ramp-up."
        required: false
        type: number
        default: 3600
      threads:
        description: "Optional (default 70) Threads to run. Equivalent to the number of nurses using the system."
        required: false
        type: number
        default: 70
      ramp_up:
        description: "Optional (default 900) Ramp-up time in seconds. Threads will be gradually started up over this time."
        required: false
        type: number
        default: 900
      vaccination_loop:
        description: "Optional (default 20) Vaccination loop (nurse journey only). The number of vaccinations each nurse will perform before logging and back in again."
        required: false
        type: number
        default: 20
        type: string
        default: '900'
      row_count:
        description: "Optional (default 1000) number of rows in the cohort file."
        required: false
        type: string
        default: '1000'
      user:
        description: "Optional (default Nurse perftest) user."
        required: true
        type: string
        default: 'nurse.perftest@example.com'
      BaseURL:
        description: "Optional (default qa.mavistesting.com) URL"
        required: true
        type: string
        default: 'qa.mavistesting.com'

jobs:
  check-image-presence:
    name: Check if docker image already exists
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    outputs:
      build-needed: ${{ steps.check-image.outputs.build-needed }}
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::393416225559:role/GitHubPerformancetestRole
          aws-region: eu-west-2
      - name: Check if image exists
        id: check-image
        run: |
          if aws ecr describe-images --repository-name performancetest --image-ids imageTag=${{ github.sha }} > /dev/null 2>&1; then
            echo "Docker image with given tag already exists"
          else
            echo "Docker image does not exist. Build needed"
            echo "build-needed=true" >> $GITHUB_OUTPUT
          fi
  build-and-push:
    needs: check-image-presence
    if: needs.check-image-presence.outputs.build-needed == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::393416225559:role/GitHubPerformancetestRole
          aws-region: eu-west-2
      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Build and push performancetest docker image
        run: |
          cd performance-tests  
          docker build -t "393416225559.dkr.ecr.eu-west-2.amazonaws.com/performancetest:${{ github.sha }}" .
          docker push "393416225559.dkr.ecr.eu-west-2.amazonaws.com/performancetest:${{ github.sha }}"
  run-performance-test:
    needs: [build-and-push, check-image-presence]
    if: ${{ !cancelled() &&
      (needs.build-and-push.result == 'success' || needs.check-image-presence.result == 'success') }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v5
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::393416225559:role/GitHubPerformancetestRole
          aws-region: eu-west-2
      - name: Create task definition
        id: create-task-definition
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition-family: "performancetest-task-definition-template"
          container-name: "performancetest-container"
          image: "393416225559.dkr.ecr.eu-west-2.amazonaws.com/performancetest:${{ github.sha }}"
          environment-variables: |
            TEST_TO_RUN=${{ inputs.testToRun }}
            URN=${{ inputs.URN }}
            DURATION=${{ inputs.duration }}
            THREADS=${{ inputs.threads }}
            RAMP_UP=${{ inputs.ramp_up }}
            VACCINATION_LOOP=${{ inputs.vaccination_loop }}
            ROW_COUNT=${{ inputs.row_count }}
          secrets: |
            AUTH_TOKEN=arn:aws:secretsmanager:eu-west-2:393416225559:secret:performancetest/auth-token
      - name: Register task definition
        id: register-task-definition
        run: |
          file_path="performancetest-task-definition.json"
          family_name="performancetest-task-definition"
          echo "$(jq --arg f "$family_name" '.family = $f' "${{ steps.create-task-definition.outputs.task-definition }}")" > "$file_path"
          task_definition_arn=$(aws ecs register-task-definition \
                                  --cli-input-json file://$file_path \
                                  --query 'taskDefinition.taskDefinitionArn' \
                                  --output text
                                )
          echo "task_definition_arn=$task_definition_arn" >> $GITHUB_OUTPUT
      - name: Run ECS Task
        id: run-task
        run: |
          echo "Starting ECS task for ${{ inputs.testToRun }} test against URN: ${{ inputs.URN }}"
          
          # Prepare network configuration
          subnet_id=$(aws ec2 describe-subnets --filters Name=tag:Name,Values=performancetest-subnet --query 'Subnets[0].SubnetId' --output text)
          security_group_id=$(aws ec2 describe-security-groups --filters Name=group-name,Values=performancetest-sg --query 'SecurityGroups[0].GroupId' --output text)
          
          aws ecs run-task \
            --cluster performancetest \
            --task-definition ${{ steps.register-task-definition.outputs.task_definition_arn }} \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[$subnet_id],securityGroups=[$security_group_id],assignPublicIp=ENABLED}" \
            --overrides '{
              "containerOverrides": [{
                "name": "performancetest-container"
              }]
            }'
          