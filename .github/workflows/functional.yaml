name: Functional tests (all devices on QA)

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  test:
    permissions:
      contents: write

    name: Test

    strategy:
      fail-fast: false
      matrix:
        device:
          - Desktop Chrome
          - Desktop Edge
          - Desktop Firefox
          - Desktop Safari
          - Galaxy S9+
          - Pixel 7
          - iPad (gen 7) landscape
          - iPhone 15
      max-parallel: 2

    runs-on: ubuntu-latest

    env:
      TZ: "Europe/London"

    steps:
      - uses: actions/checkout@v4

      - name: Sanitize device name
        id: sanitize-device
        run: |
          sanitized=$(echo "${{ matrix.device }}" | tr -cd '[:alnum:]_-')
          echo "sanitized_device=$sanitized" >> $GITHUB_OUTPUT

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Install Playwright
        run: uv run playwright install --with-deps

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run tests
        run: uv run pytest --device "${{ matrix.device }}"
        env:
          BASE_URL: ${{ vars.BASE_URL }}
          PROGRAMMES_ENABLED: ${{ vars.PROGRAMMES_ENABLED }}
          BASIC_AUTH_PASSWORD: ${{ secrets.BASIC_AUTH_PASSWORD }}
          BASIC_AUTH_USERNAME: ${{ secrets.BASIC_AUTH_USERNAME }}

      - name: Generate Allure report
        if: always()
        run: |
          npx allure-commandline generate allure-results -o allure-report

      - name: Deploy Allure report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          publish_branch: gh-pages
          destination_dir: ${{ github.ref_name }}/${{ steps.sanitize-device.outputs.sanitized_device }}
          force_orphan: true
      
      - name: Set Job Summary
        if: always()
        run: |
          echo "Test report URL is https://nhsdigital.github.io/manage-vaccinations-in-schools-testing/${{ github.ref_name }}/${{ steps.sanitize-device.outputs.sanitized_device }}" >> $GITHUB_STEP_SUMMARY
