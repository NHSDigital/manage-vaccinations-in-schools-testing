name: "Run Tests"
description: "Execute Functional tests"
inputs:
  device:
    required: true
  base_url:
    required: true
  programmes_enabled:
    required: true
  set_feature_flags:
    default: "false"
  additional_feature_flags:
    default: ""
  playwright_cache_hit:
    required: true

runs:
  using: composite
  steps:
    - name: Install uv
      uses: astral-sh/setup-uv@v6

    - name: Install Playwright if not cached
      if: inputs.playwright_cache_hit != 'true'
      run: uv run playwright install
      shell: bash

    - name: Install Playwright dependencies if using webkit
      if: inputs.device == 'Desktop Safari' || inputs.device == 'iPad (gen 7) landscape' || inputs.device == 'iPhone 15'
      run: uv run playwright install-deps webkit
      shell: bash

    - name: Run tests
      run: uv run pytest --reruns 2 --device "${{ inputs.device }}"
      shell: bash
      env:
        BASE_URL: ${{ inputs.base_url }}
        PROGRAMMES_ENABLED: ${{ inputs.programmes_enabled }}
        SET_FEATURE_FLAGS: ${{ inputs.set_feature_flags }}
        ADDITIONAL_FEATURE_FLAGS: ${{ inputs.additional_feature_flags }}
        BASIC_AUTH_TOKEN: ${{ env.BASIC_AUTH_TOKEN }}
        IMMS_BASE_URL: ${{ env.IMMS_BASE_URL }}
        IMMS_API_KEY: ${{ env.IMMS_API_KEY }}
        IMMS_API_KID: ${{ env.IMMS_API_KID }}
        IMMS_API_PEM: ${{ env.IMMS_API_PEM }}
